<!DOCTYPE html>
<html>
<head>
    <title>STOMP 채팅 테스트 - 초대 및 그룹 채팅 기능 포함</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; }
        input, button { padding: 8px; margin: 5px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; background: #f9f9f9; font-size: 12px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        #chatMessages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #fff; }
        .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .sent { background: #d1ecf1; text-align: right; }
        .received { background: #d4edda; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .invite-section { background: #f8f9fa; }
        .group-section { background: #e8f5e8; }
        .room-info { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: #721c24; background: #f8d7da; padding: 5px; border-radius: 3px; }
        .success { color: #155724; background: #d4edda; padding: 5px; border-radius: 3px; }
        .info { color: #0c5460; background: #d1ecf1; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>STOMP 채팅 테스트 - 초대 및 그룹 채팅 기능 포함</h2>
        
        <!-- 기본 연결 섹션 -->
        <div class="section">
            <h3>🔌 기본 연결</h3>
            <div class="form-group">
                <label>사용자 ID:</label>
                <input type="text" id="userId" placeholder="JWT 토큰에서 자동 설정됨" style="width: 400px;">
                <small style="color: #666;">JWT 토큰을 입력하고 "사용자 ID 추출" 버튼을 클릭하면 자동으로 설정됩니다</small>
            </div>
            
            <div class="form-group">
                <label>JWT 토큰:</label>
                <input type="text" id="jwtToken" placeholder="JWT 토큰 입력" style="width: 400px;">
            </div>
            
            <div class="form-group">
                <button onclick="extractUserId()" id="extractBtn">사용자 ID 추출</button>
                <button onclick="connect()" id="connectBtn" disabled>연결 및 구독</button>
                <button onclick="disconnect()" id="disconnectBtn" disabled>연결 해제</button>
            </div>
            
            <div id="status" class="status disconnected">연결되지 않음</div>
        </div>

        <!-- 채팅방 관리 섹션 -->
        <div class="section">
            <h3>💬 채팅방 관리</h3>
            <div class="form-group">
                <label>채팅방 ID:</label>
                <input type="text" id="roomId" placeholder="채팅방 ID 입력 (UUID 형식)">
                <button onclick="getRoomInfo()" id="roomInfoBtn" disabled>채팅방 정보 조회</button>
            </div>
            
            <div class="form-group">
                <label>메시지:</label>
                <input type="text" id="messageInput" placeholder="메시지 입력" disabled>
                <button onclick="sendMessage()" id="sendBtn" disabled>전송</button>
            </div>
            
            <div id="roomInfo" class="room-info" style="display: none;"></div>
        </div>

        <!-- 1:1 채팅방 생성 섹션 -->
        <div class="section">
            <h3>👥 1:1 채팅방 생성</h3>
            <div class="form-group">
                <label>참여자 ID:</label>
                <input type="text" id="participantId" placeholder="참여할 사용자 ID (UUID)">
                <button onclick="createOneToOneRoom()" id="createOneToOneBtn" disabled>1:1 채팅방 생성</button>
            </div>
        </div>

        <!-- 그룹 채팅방 생성 섹션 -->
        <div class="section group-section">
            <h3>👥👥 그룹 채팅방 생성</h3>
            <div class="form-group">
                <label>채팅방 이름:</label>
                <input type="text" id="groupRoomName" placeholder="그룹 채팅방 이름">
            </div>
            <div class="form-group">
                <label>참여자 ID들:</label>
                <textarea id="groupParticipantIds" placeholder="참여할 사용자 ID들을 줄바꿈으로 구분하여 입력 (UUID)" rows="3" style="width: 300px;"></textarea>
            </div>
            <div class="form-group">
                <button onclick="createGroupRoom()" id="createGroupBtn" disabled>그룹 채팅방 생성</button>
            </div>
        </div>

        <!-- 사용자 초대 섹션 -->
        <div class="section invite-section">
            <h3>📨 사용자 초대</h3>
            <div class="form-group">
                <label>초대할 사용자 ID들:</label>
                <textarea id="inviteUserIds" placeholder="초대할 사용자 ID들을 줄바꿈으로 구분하여 입력 (UUID)" rows="3" style="width: 300px;"></textarea>
            </div>
            <div class="form-group">
                <button onclick="inviteUsers()" id="inviteBtn" disabled>사용자 초대</button>
            </div>
        </div>

        <!-- 사용자 관리 섹션 -->
        <div class="section">
            <h3>👤 사용자 관리</h3>
            <div class="form-group">
                <label>내보낼 사용자 ID:</label>
                <input type="text" id="removeUserId" placeholder="내보낼 사용자 ID (UUID)">
                <button onclick="removeUser()" id="removeBtn" disabled>사용자 내보내기</button>
            </div>
            <div class="form-group">
                <label>새 채팅방 이름:</label>
                <input type="text" id="newRoomName" placeholder="새로운 채팅방 이름">
                <button onclick="updateRoomName()" id="updateNameBtn" disabled>이름 변경</button>
            </div>
        </div>

        <!-- 채팅 메시지 섹션 -->
        <div class="section">
            <h3>💬 채팅 메시지</h3>
            <div id="chatMessages"></div>
        </div>

        <!-- 로그 섹션 -->
        <div class="section">
            <h3>📋 로그</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let isConnected = false;
        let receivedMessageIds = new Set();
        let lastMessageContent = '';
        let lastMessageTime = 0;
        let currentRoomId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            let colorClass = '';
            if (type === 'good') { colorClass = 'success'; } 
            else if (type === 'bad') { colorClass = 'error'; }
            else if (type === 'info') { colorClass = 'info'; }
            
            logDiv.innerHTML += `<span class="${colorClass}">[${time}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(connected, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
            
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('messageInput').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            document.getElementById('roomInfoBtn').disabled = !connected;
            document.getElementById('createOneToOneBtn').disabled = !connected;
            document.getElementById('createGroupBtn').disabled = !connected;
            document.getElementById('inviteBtn').disabled = !connected;
            document.getElementById('removeBtn').disabled = !connected;
            document.getElementById('updateNameBtn').disabled = !connected;
            
            // 연결 상태에 따라 채팅방 ID 입력 필드 제어
            document.getElementById('roomId').disabled = connected;
        }
        
        function displayMessage(data, isSent) {
            let messageId = null;
            try {
                if (data.messageId) {
                    messageId = data.messageId;
                } else if (data.payload && data.payload.messageId) {
                    messageId = data.payload.messageId;
                }
                
                if (messageId && receivedMessageIds.has(messageId)) {
                    log('중복 메시지 무시: ' + messageId, 'info');
                    return;
                }
                
                if (messageId) {
                    receivedMessageIds.add(messageId);
                }
            } catch (e) {
                log('메시지 ID 추출 실패: ' + e.message, 'info');
            }
            
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            let messageText = '';
            let senderName = '';
            
            try {
                if (data.type === 'chat.message' && data.payload) {
                    const payload = data.payload;
                    messageText = payload.content || '내용 없음';
                    senderName = payload.sender ? payload.sender.nickname : '알 수 없음';
                } else {
                    messageText = data.content;
                    senderName = data.sender ? data.sender.nickname : '알 수 없음';
                }
            } catch (e) {
                messageText = JSON.stringify(data);
                senderName = '시스템';
            }
            
            messageDiv.innerHTML = `<strong>${isSent ? '나' : senderName}</strong>: ${messageText}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (messageId) {
                log(`메시지 표시 완료: ${isSent ? '내가 보낸' : '상대방이 보낸'} (ID: ${messageId})`, 'info');
            }
        }
        
        function extractUserId() {
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!jwtToken) {
                alert('JWT 토큰을 먼저 입력하세요.');
                return;
            }
            
            try {
                const tokenParts = jwtToken.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    const actualUserId = payload.sub;
                    
                    document.getElementById('userId').value = actualUserId;
                    
                    log('JWT에서 추출된 실제 사용자 ID: ' + actualUserId, 'good');
                    log('이제 연결 버튼을 클릭하여 WebSocket에 연결할 수 있습니다.', 'info');
                    
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('extractBtn').disabled = true;
                    
                } else {
                    throw new Error('JWT 토큰 형식이 올바르지 않습니다.');
                }
            } catch (e) {
                log('JWT 토큰 파싱 실패: ' + e.message, 'bad');
                alert('JWT 토큰이 올바르지 않습니다.');
                return;
            }
        }
        
        function connect() {
            const userId = document.getElementById('userId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            let roomId = document.getElementById('roomId').value.trim();
            
            if (!userId || !jwtToken) {
                alert('먼저 JWT 토큰을 입력하고 "사용자 ID 추출" 버튼을 클릭하세요.');
                return;
            }

            // 채팅방 ID가 없으면 임시로 생성 (테스트용)
            if (!roomId) {
                roomId = generateTestRoomId();
                document.getElementById('roomId').value = roomId;
                log('채팅방 ID가 없어서 테스트용 임시 ID를 생성했습니다: ' + roomId, 'info');
            }

            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(roomId)) {
                alert('채팅방 ID 형식이 올바르지 않습니다. UUID 형식이어야 합니다.');
                return;
            }

            log('연결 및 구독 시도 중...', 'info');
            currentRoomId = roomId;
            
            const sockjsUrl = '/ws/chat?token=' + encodeURIComponent(jwtToken);
            const socket = new SockJS(sockjsUrl);
            stompClient = Stomp.over(socket);
            
            const headers = {
                'Authorization': `Bearer ${jwtToken}`
            };

            stompClient.connect(headers, frame => {
                log('STOMP 연결 성공 ✅', 'good');
                log('연결된 채팅방 ID: ' + roomId, 'good');
                log('이제 메시지를 전송하거나 다른 기능을 테스트할 수 있습니다!', 'good');
                isConnected = true;
                updateStatus(true, '연결됨');
                
                if (stompClient.subscriptions && Object.keys(stompClient.subscriptions).length > 0) {
                    log('기존 구독 해제 중...', 'info');
                    Object.keys(stompClient.subscriptions).forEach(key => {
                        stompClient.unsubscribe(key);
                        log('구독 해제됨: ' + key, 'info');
                    });
                }

                log('채팅방 구독 시작: /topic/chat/' + roomId, 'info');
                stompClient.subscribe(`/topic/chat/${roomId}`, message => {
                    log('채팅방 메시지 수신: ' + message.body);
                    try {
                        const data = JSON.parse(message.body);
                        const currentUserId = document.getElementById('userId').value.trim();
                        
                        let isSent = false;
                        if (data.payload && data.payload.sender && data.payload.sender.id === currentUserId) {
                            isSent = true;
                        }

                        const messageId = data.payload ? data.payload.id : null;
                        const messageContent = data.payload ? data.payload.content : '';
                        const currentTime = Date.now();
                        
                        if (messageId && receivedMessageIds.has(messageId)) {
                            log('메시지 ID 중복 무시: ' + messageId, 'info');
                            return;
                        }
                        
                        if (messageContent === lastMessageContent && 
                            isSent === (lastMessageContent !== '') && 
                            (currentTime - lastMessageTime) < 1000) {
                            log('동일 내용 중복 무시: ' + messageContent, 'info');
                            return;
                        }
                        
                        if (messageId) {
                            receivedMessageIds.add(messageId);
                        }
                        lastMessageContent = messageContent;
                        lastMessageTime = currentTime;

                        displayMessage(data, isSent);
                        log('메시지 표시 완료 - ' + (isSent ? '내가 보낸' : '상대방이 보낸') + ' (내용: ' + messageContent + ')');

                    } catch (e) {
                        log('메시지 파싱 오류: ' + e.message, 'bad');
                    }
                });
                
            }, error => {
                log('STOMP 연결 실패 ❌: ' + error, 'bad');
                log('연결 실패 원인 분석:', 'bad');
                log('- JWT 토큰이 유효한지 확인', 'bad');
                log('- 서버가 실행 중인지 확인', 'bad');
                updateStatus(false, '연결 실패');
            });
        }
        
        function disconnect() {
            if (stompClient) {
                if (stompClient.subscriptions) {
                    Object.keys(stompClient.subscriptions).forEach(key => {
                        stompClient.unsubscribe(key);
                        log('구독 해제됨: ' + key, 'info');
                    });
                }
                
                receivedMessageIds.clear();
                lastMessageContent = '';
                lastMessageTime = 0;
                currentRoomId = null;
                
                stompClient.disconnect(() => {
                    log('연결 해제됨');
                    isConnected = false;
                    updateStatus(false, '연결 해제됨');
                    
                    // 연결 해제 후 채팅방 ID 입력 필드 초기화
                    document.getElementById('roomId').value = '';
                });
            }
        }
        
        function sendMessage() {
            if (!isConnected) {
                alert('연결되지 않았습니다.');
                return;
            }
            
            const content = document.getElementById('messageInput').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!content) {
                alert('메시지를 입력하세요.');
                return;
            }
            
            const message = {
                roomId: roomId,
                content: content,
                clientMessageId: 'msg-' + Date.now()
            };
            
            stompClient.send(`/app/send-message`, {}, JSON.stringify(message));
            
            log('메시지 전송: ' + JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

        // 1:1 채팅방 생성
        async function createOneToOneRoom() {
            const participantId = document.getElementById('participantId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!participantId) {
                alert('참여자 ID를 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms?participantId=' + participantId, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomId = result.data.id;
                    document.getElementById('roomId').value = roomId;
                    log('1:1 채팅방 생성 성공! 채팅방 ID: ' + roomId, 'good');
                    log('이제 연결 버튼을 클릭하여 채팅방에 참여할 수 있습니다.', 'info');
                } else {
                    const error = await response.text();
                    log('1:1 채팅방 생성 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('1:1 채팅방 생성 중 오류: ' + error.message, 'bad');
            }
        }

        // 그룹 채팅방 생성
        async function createGroupRoom() {
            const roomName = document.getElementById('groupRoomName').value.trim();
            const participantIdsText = document.getElementById('groupParticipantIds').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomName || !participantIdsText) {
                alert('채팅방 이름과 참여자 ID들을 입력하세요.');
                return;
            }

            const participantIds = participantIdsText.split('\n').map(id => id.trim()).filter(id => id);
            
            if (participantIds.length === 0) {
                alert('유효한 참여자 ID를 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/group?roomName=' + encodeURIComponent(roomName), {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userIds: participantIds })
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomId = result.data.id;
                    document.getElementById('roomId').value = roomId;
                    log('그룹 채팅방 생성 성공! 채팅방 ID: ' + roomId, 'good');
                    log('채팅방 이름: ' + roomName, 'good');
                    log('참여자 수: ' + participantIds.length + '명', 'good');
                    log('이제 연결 버튼을 클릭하여 채팅방에 참여할 수 있습니다.', 'info');
                } else {
                    const error = await response.text();
                    log('그룹 채팅방 생성 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('그룹 채팅방 생성 중 오류: ' + error.message, 'bad');
            }
        }

        // 사용자 초대
        async function inviteUsers() {
            const roomId = document.getElementById('roomId').value.trim();
            const inviteUserIdsText = document.getElementById('inviteUserIds').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !inviteUserIdsText) {
                alert('채팅방 ID와 초대할 사용자 ID들을 입력하세요.');
                return;
            }

            const inviteUserIds = inviteUserIdsText.split('\n').map(id => id.trim()).filter(id => id);
            
            if (inviteUserIds.length === 0) {
                alert('유효한 사용자 ID를 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/invite', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userIds: inviteUserIds })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('사용자 초대 성공!', 'good');
                    log('초대된 사용자 수: ' + inviteUserIds.length + '명', 'good');
                    log('채팅방 타입: ' + result.data.type, 'info');
                    document.getElementById('inviteUserIds').value = '';
                } else {
                    const error = await response.text();
                    log('사용자 초대 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('사용자 초대 중 오류: ' + error.message, 'bad');
            }
        }

        // 사용자 내보내기
        async function removeUser() {
            const roomId = document.getElementById('roomId').value.trim();
            const removeUserId = document.getElementById('removeUserId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !removeUserId) {
                alert('채팅방 ID와 내보낼 사용자 ID를 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/users/' + removeUserId, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log('사용자 내보내기 성공!', 'good');
                    log('내보낸 사용자 ID: ' + removeUserId, 'good');
                    log('채팅방 타입: ' + result.data.type, 'info');
                    document.getElementById('removeUserId').value = '';
                } else {
                    const error = await response.text();
                    log('사용자 내보내기 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('사용자 내보내기 중 오류: ' + error.message, 'bad');
            }
        }

        // 채팅방 이름 변경
        async function updateRoomName() {
            const roomId = document.getElementById('roomId').value.trim();
            const newRoomName = document.getElementById('newRoomName').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !newRoomName) {
                alert('채팅방 ID와 새로운 이름을 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/name?newName=' + encodeURIComponent(newRoomName), {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log('채팅방 이름 변경 성공!', 'good');
                    log('새로운 이름: ' + newRoomName, 'good');
                    document.getElementById('newRoomName').value = '';
                } else {
                    const error = await response.text();
                    log('채팅방 이름 변경 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('채팅방 이름 변경 중 오류: ' + error.message, 'bad');
            }
        }

        // 채팅방 정보 조회
        async function getRoomInfo() {
            const roomId = document.getElementById('roomId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId) {
                alert('채팅방 ID를 입력하세요.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/messages?size=1', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomInfo = result.data;
                    
                    const roomInfoDiv = document.getElementById('roomInfo');
                    roomInfoDiv.style.display = 'block';
                    roomInfoDiv.innerHTML = `
                        <h4>채팅방 정보</h4>
                        <p><strong>ID:</strong> ${roomInfo.content[0]?.chatRoomId || roomId}</p>
                        <p><strong>참여자 수:</strong> ${roomInfo.totalElements}명</p>
                        <p><strong>마지막 메시지:</strong> ${roomInfo.content[0]?.content || '없음'}</p>
                    `;
                    
                    log('채팅방 정보 조회 성공!', 'good');
                } else {
                    const error = await response.text();
                    log('채팅방 정보 조회 실패: ' + error, 'bad');
                }
            } catch (error) {
                log('채팅방 정보 조회 중 오류: ' + error.message, 'bad');
            }
        }
        
        // 테스트용 UUID 생성 함수
        function generateTestRoomId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Enter 키로 메시지 전송
        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>