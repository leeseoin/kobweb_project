<!DOCTYPE html>
<html>
<head>
    <title>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸ - ì´ˆëŒ€ ë° ê·¸ë£¹ ì±„íŒ… ê¸°ëŠ¥ í¬í•¨</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; }
        input, button { padding: 8px; margin: 5px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; background: #f9f9f9; font-size: 12px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        #chatMessages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #fff; }
        .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .sent { background: #d1ecf1; text-align: right; }
        .received { background: #d4edda; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .invite-section { background: #f8f9fa; }
        .group-section { background: #e8f5e8; }
        .room-info { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: #721c24; background: #f8d7da; padding: 5px; border-radius: 3px; }
        .success { color: #155724; background: #d4edda; padding: 5px; border-radius: 3px; }
        .info { color: #0c5460; background: #d1ecf1; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸ - ì´ˆëŒ€ ë° ê·¸ë£¹ ì±„íŒ… ê¸°ëŠ¥ í¬í•¨</h2>
        
        <!-- ê¸°ë³¸ ì—°ê²° ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ”Œ ê¸°ë³¸ ì—°ê²°</h3>
            <div class="form-group">
                <label>ì‚¬ìš©ì ID:</label>
                <input type="text" id="userId" placeholder="JWT í† í°ì—ì„œ ìë™ ì„¤ì •ë¨" style="width: 400px;">
                <small style="color: #666;">JWT í† í°ì„ ì…ë ¥í•˜ê³  "ì‚¬ìš©ì ID ì¶”ì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</small>
            </div>
            
            <div class="form-group">
                <label>JWT í† í°:</label>
                <input type="text" id="jwtToken" placeholder="JWT í† í° ì…ë ¥" style="width: 400px;">
            </div>
            
            <div class="form-group">
                <button onclick="extractUserId()" id="extractBtn">ì‚¬ìš©ì ID ì¶”ì¶œ</button>
                <button onclick="connect()" id="connectBtn" disabled>ì—°ê²° ë° êµ¬ë…</button>
                <button onclick="disconnect()" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
            </div>
            
            <div id="status" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
        </div>

        <!-- ì±„íŒ…ë°© ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ’¬ ì±„íŒ…ë°© ê´€ë¦¬</h3>
            <div class="form-group">
                <label>ì±„íŒ…ë°© ID:</label>
                <input type="text" id="roomId" placeholder="ì±„íŒ…ë°© ID ì…ë ¥ (UUID í˜•ì‹)">
                <button onclick="getRoomInfo()" id="roomInfoBtn" disabled>ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ</button>
            </div>
            
            <div class="form-group">
                <label>ë©”ì‹œì§€:</label>
                <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" disabled>
                <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
            </div>
            
            <div id="roomInfo" class="room-info" style="display: none;"></div>
        </div>

        <!-- 1:1 ì±„íŒ…ë°© ìƒì„± ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ‘¥ 1:1 ì±„íŒ…ë°© ìƒì„±</h3>
            <div class="form-group">
                <label>ì°¸ì—¬ì ID:</label>
                <input type="text" id="participantId" placeholder="ì°¸ì—¬í•  ì‚¬ìš©ì ID (UUID)">
                <button onclick="createOneToOneRoom()" id="createOneToOneBtn" disabled>1:1 ì±„íŒ…ë°© ìƒì„±</button>
            </div>
        </div>

        <!-- ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ì„¹ì…˜ -->
        <div class="section group-section">
            <h3>ğŸ‘¥ğŸ‘¥ ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„±</h3>
            <div class="form-group">
                <label>ì±„íŒ…ë°© ì´ë¦„:</label>
                <input type="text" id="groupRoomName" placeholder="ê·¸ë£¹ ì±„íŒ…ë°© ì´ë¦„">
            </div>
            <div class="form-group">
                <label>ì°¸ì—¬ì IDë“¤:</label>
                <textarea id="groupParticipantIds" placeholder="ì°¸ì—¬í•  ì‚¬ìš©ì IDë“¤ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ (UUID)" rows="3" style="width: 300px;"></textarea>
            </div>
            <div class="form-group">
                <button onclick="createGroupRoom()" id="createGroupBtn" disabled>ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„±</button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ì´ˆëŒ€ ì„¹ì…˜ -->
        <div class="section invite-section">
            <h3>ğŸ“¨ ì‚¬ìš©ì ì´ˆëŒ€</h3>
            <div class="form-group">
                <label>ì´ˆëŒ€í•  ì‚¬ìš©ì IDë“¤:</label>
                <textarea id="inviteUserIds" placeholder="ì´ˆëŒ€í•  ì‚¬ìš©ì IDë“¤ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ (UUID)" rows="3" style="width: 300px;"></textarea>
            </div>
            <div class="form-group">
                <button onclick="inviteUsers()" id="inviteBtn" disabled>ì‚¬ìš©ì ì´ˆëŒ€</button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬</h3>
            <div class="form-group">
                <label>ë‚´ë³´ë‚¼ ì‚¬ìš©ì ID:</label>
                <input type="text" id="removeUserId" placeholder="ë‚´ë³´ë‚¼ ì‚¬ìš©ì ID (UUID)">
                <button onclick="removeUser()" id="removeBtn" disabled>ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸°</button>
            </div>
            <div class="form-group">
                <label>ìƒˆ ì±„íŒ…ë°© ì´ë¦„:</label>
                <input type="text" id="newRoomName" placeholder="ìƒˆë¡œìš´ ì±„íŒ…ë°© ì´ë¦„">
                <button onclick="updateRoomName()" id="updateNameBtn" disabled>ì´ë¦„ ë³€ê²½</button>
            </div>
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€</h3>
            <div id="chatMessages"></div>
        </div>

        <!-- ë¡œê·¸ ì„¹ì…˜ -->
        <div class="section">
            <h3>ğŸ“‹ ë¡œê·¸</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let isConnected = false;
        let receivedMessageIds = new Set();
        let lastMessageContent = '';
        let lastMessageTime = 0;
        let currentRoomId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            let colorClass = '';
            if (type === 'good') { colorClass = 'success'; } 
            else if (type === 'bad') { colorClass = 'error'; }
            else if (type === 'info') { colorClass = 'info'; }
            
            logDiv.innerHTML += `<span class="${colorClass}">[${time}] ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(connected, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
            
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('messageInput').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            document.getElementById('roomInfoBtn').disabled = !connected;
            document.getElementById('createOneToOneBtn').disabled = !connected;
            document.getElementById('createGroupBtn').disabled = !connected;
            document.getElementById('inviteBtn').disabled = !connected;
            document.getElementById('removeBtn').disabled = !connected;
            document.getElementById('updateNameBtn').disabled = !connected;
            
            // ì—°ê²° ìƒíƒœì— ë”°ë¼ ì±„íŒ…ë°© ID ì…ë ¥ í•„ë“œ ì œì–´
            document.getElementById('roomId').disabled = connected;
        }
        
        function displayMessage(data, isSent) {
            let messageId = null;
            try {
                if (data.messageId) {
                    messageId = data.messageId;
                } else if (data.payload && data.payload.messageId) {
                    messageId = data.payload.messageId;
                }
                
                if (messageId && receivedMessageIds.has(messageId)) {
                    log('ì¤‘ë³µ ë©”ì‹œì§€ ë¬´ì‹œ: ' + messageId, 'info');
                    return;
                }
                
                if (messageId) {
                    receivedMessageIds.add(messageId);
                }
            } catch (e) {
                log('ë©”ì‹œì§€ ID ì¶”ì¶œ ì‹¤íŒ¨: ' + e.message, 'info');
            }
            
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            let messageText = '';
            let senderName = '';
            
            try {
                if (data.type === 'chat.message' && data.payload) {
                    const payload = data.payload;
                    messageText = payload.content || 'ë‚´ìš© ì—†ìŒ';
                    senderName = payload.sender ? payload.sender.nickname : 'ì•Œ ìˆ˜ ì—†ìŒ';
                } else {
                    messageText = data.content;
                    senderName = data.sender ? data.sender.nickname : 'ì•Œ ìˆ˜ ì—†ìŒ';
                }
            } catch (e) {
                messageText = JSON.stringify(data);
                senderName = 'ì‹œìŠ¤í…œ';
            }
            
            messageDiv.innerHTML = `<strong>${isSent ? 'ë‚˜' : senderName}</strong>: ${messageText}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (messageId) {
                log(`ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ: ${isSent ? 'ë‚´ê°€ ë³´ë‚¸' : 'ìƒëŒ€ë°©ì´ ë³´ë‚¸'} (ID: ${messageId})`, 'info');
            }
        }
        
        function extractUserId() {
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!jwtToken) {
                alert('JWT í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const tokenParts = jwtToken.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1]));
                    const actualUserId = payload.sub;
                    
                    document.getElementById('userId').value = actualUserId;
                    
                    log('JWTì—ì„œ ì¶”ì¶œëœ ì‹¤ì œ ì‚¬ìš©ì ID: ' + actualUserId, 'good');
                    log('ì´ì œ ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ WebSocketì— ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
                    
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('extractBtn').disabled = true;
                    
                } else {
                    throw new Error('JWT í† í° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                log('JWT í† í° íŒŒì‹± ì‹¤íŒ¨: ' + e.message, 'bad');
                alert('JWT í† í°ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
        }
        
        function connect() {
            const userId = document.getElementById('userId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            let roomId = document.getElementById('roomId').value.trim();
            
            if (!userId || !jwtToken) {
                alert('ë¨¼ì € JWT í† í°ì„ ì…ë ¥í•˜ê³  "ì‚¬ìš©ì ID ì¶”ì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                return;
            }

            // ì±„íŒ…ë°© IDê°€ ì—†ìœ¼ë©´ ì„ì‹œë¡œ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
            if (!roomId) {
                roomId = generateTestRoomId();
                document.getElementById('roomId').value = roomId;
                log('ì±„íŒ…ë°© IDê°€ ì—†ì–´ì„œ í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ IDë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤: ' + roomId, 'info');
            }

            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(roomId)) {
                alert('ì±„íŒ…ë°© ID í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. UUID í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            log('ì—°ê²° ë° êµ¬ë… ì‹œë„ ì¤‘...', 'info');
            currentRoomId = roomId;
            
            const sockjsUrl = '/ws/chat?token=' + encodeURIComponent(jwtToken);
            const socket = new SockJS(sockjsUrl);
            stompClient = Stomp.over(socket);
            
            const headers = {
                'Authorization': `Bearer ${jwtToken}`
            };

            stompClient.connect(headers, frame => {
                log('STOMP ì—°ê²° ì„±ê³µ âœ…', 'good');
                log('ì—°ê²°ëœ ì±„íŒ…ë°© ID: ' + roomId, 'good');
                log('ì´ì œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê±°ë‚˜ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!', 'good');
                isConnected = true;
                updateStatus(true, 'ì—°ê²°ë¨');
                
                if (stompClient.subscriptions && Object.keys(stompClient.subscriptions).length > 0) {
                    log('ê¸°ì¡´ êµ¬ë… í•´ì œ ì¤‘...', 'info');
                    Object.keys(stompClient.subscriptions).forEach(key => {
                        stompClient.unsubscribe(key);
                        log('êµ¬ë… í•´ì œë¨: ' + key, 'info');
                    });
                }

                log('ì±„íŒ…ë°© êµ¬ë… ì‹œì‘: /topic/chat/' + roomId, 'info');
                stompClient.subscribe(`/topic/chat/${roomId}`, message => {
                    log('ì±„íŒ…ë°© ë©”ì‹œì§€ ìˆ˜ì‹ : ' + message.body);
                    try {
                        const data = JSON.parse(message.body);
                        const currentUserId = document.getElementById('userId').value.trim();
                        
                        let isSent = false;
                        if (data.payload && data.payload.sender && data.payload.sender.id === currentUserId) {
                            isSent = true;
                        }

                        const messageId = data.payload ? data.payload.id : null;
                        const messageContent = data.payload ? data.payload.content : '';
                        const currentTime = Date.now();
                        
                        if (messageId && receivedMessageIds.has(messageId)) {
                            log('ë©”ì‹œì§€ ID ì¤‘ë³µ ë¬´ì‹œ: ' + messageId, 'info');
                            return;
                        }
                        
                        if (messageContent === lastMessageContent && 
                            isSent === (lastMessageContent !== '') && 
                            (currentTime - lastMessageTime) < 1000) {
                            log('ë™ì¼ ë‚´ìš© ì¤‘ë³µ ë¬´ì‹œ: ' + messageContent, 'info');
                            return;
                        }
                        
                        if (messageId) {
                            receivedMessageIds.add(messageId);
                        }
                        lastMessageContent = messageContent;
                        lastMessageTime = currentTime;

                        displayMessage(data, isSent);
                        log('ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ - ' + (isSent ? 'ë‚´ê°€ ë³´ë‚¸' : 'ìƒëŒ€ë°©ì´ ë³´ë‚¸') + ' (ë‚´ìš©: ' + messageContent + ')');

                    } catch (e) {
                        log('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'bad');
                    }
                });
                
            }, error => {
                log('STOMP ì—°ê²° ì‹¤íŒ¨ âŒ: ' + error, 'bad');
                log('ì—°ê²° ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:', 'bad');
                log('- JWT í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸', 'bad');
                log('- ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸', 'bad');
                updateStatus(false, 'ì—°ê²° ì‹¤íŒ¨');
            });
        }
        
        function disconnect() {
            if (stompClient) {
                if (stompClient.subscriptions) {
                    Object.keys(stompClient.subscriptions).forEach(key => {
                        stompClient.unsubscribe(key);
                        log('êµ¬ë… í•´ì œë¨: ' + key, 'info');
                    });
                }
                
                receivedMessageIds.clear();
                lastMessageContent = '';
                lastMessageTime = 0;
                currentRoomId = null;
                
                stompClient.disconnect(() => {
                    log('ì—°ê²° í•´ì œë¨');
                    isConnected = false;
                    updateStatus(false, 'ì—°ê²° í•´ì œë¨');
                    
                    // ì—°ê²° í•´ì œ í›„ ì±„íŒ…ë°© ID ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('roomId').value = '';
                });
            }
        }
        
        function sendMessage() {
            if (!isConnected) {
                alert('ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const content = document.getElementById('messageInput').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!content) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const message = {
                roomId: roomId,
                content: content,
                clientMessageId: 'msg-' + Date.now()
            };
            
            stompClient.send(`/app/send-message`, {}, JSON.stringify(message));
            
            log('ë©”ì‹œì§€ ì „ì†¡: ' + JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

        // 1:1 ì±„íŒ…ë°© ìƒì„±
        async function createOneToOneRoom() {
            const participantId = document.getElementById('participantId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!participantId) {
                alert('ì°¸ì—¬ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms?participantId=' + participantId, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomId = result.data.id;
                    document.getElementById('roomId').value = roomId;
                    log('1:1 ì±„íŒ…ë°© ìƒì„± ì„±ê³µ! ì±„íŒ…ë°© ID: ' + roomId, 'good');
                    log('ì´ì œ ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì±„íŒ…ë°©ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
                } else {
                    const error = await response.text();
                    log('1:1 ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('1:1 ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }

        // ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„±
        async function createGroupRoom() {
            const roomName = document.getElementById('groupRoomName').value.trim();
            const participantIdsText = document.getElementById('groupParticipantIds').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomName || !participantIdsText) {
                alert('ì±„íŒ…ë°© ì´ë¦„ê³¼ ì°¸ì—¬ì IDë“¤ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const participantIds = participantIdsText.split('\n').map(id => id.trim()).filter(id => id);
            
            if (participantIds.length === 0) {
                alert('ìœ íš¨í•œ ì°¸ì—¬ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/group?roomName=' + encodeURIComponent(roomName), {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userIds: participantIds })
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomId = result.data.id;
                    document.getElementById('roomId').value = roomId;
                    log('ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ì„±ê³µ! ì±„íŒ…ë°© ID: ' + roomId, 'good');
                    log('ì±„íŒ…ë°© ì´ë¦„: ' + roomName, 'good');
                    log('ì°¸ì—¬ì ìˆ˜: ' + participantIds.length + 'ëª…', 'good');
                    log('ì´ì œ ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì±„íŒ…ë°©ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
                } else {
                    const error = await response.text();
                    log('ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }

        // ì‚¬ìš©ì ì´ˆëŒ€
        async function inviteUsers() {
            const roomId = document.getElementById('roomId').value.trim();
            const inviteUserIdsText = document.getElementById('inviteUserIds').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !inviteUserIdsText) {
                alert('ì±„íŒ…ë°© IDì™€ ì´ˆëŒ€í•  ì‚¬ìš©ì IDë“¤ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            const inviteUserIds = inviteUserIdsText.split('\n').map(id => id.trim()).filter(id => id);
            
            if (inviteUserIds.length === 0) {
                alert('ìœ íš¨í•œ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/invite', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userIds: inviteUserIds })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('ì‚¬ìš©ì ì´ˆëŒ€ ì„±ê³µ!', 'good');
                    log('ì´ˆëŒ€ëœ ì‚¬ìš©ì ìˆ˜: ' + inviteUserIds.length + 'ëª…', 'good');
                    log('ì±„íŒ…ë°© íƒ€ì…: ' + result.data.type, 'info');
                    document.getElementById('inviteUserIds').value = '';
                } else {
                    const error = await response.text();
                    log('ì‚¬ìš©ì ì´ˆëŒ€ ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('ì‚¬ìš©ì ì´ˆëŒ€ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }

        // ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸°
        async function removeUser() {
            const roomId = document.getElementById('roomId').value.trim();
            const removeUserId = document.getElementById('removeUserId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !removeUserId) {
                alert('ì±„íŒ…ë°© IDì™€ ë‚´ë³´ë‚¼ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/users/' + removeUserId, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log('ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸° ì„±ê³µ!', 'good');
                    log('ë‚´ë³´ë‚¸ ì‚¬ìš©ì ID: ' + removeUserId, 'good');
                    log('ì±„íŒ…ë°© íƒ€ì…: ' + result.data.type, 'info');
                    document.getElementById('removeUserId').value = '';
                } else {
                    const error = await response.text();
                    log('ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }

        // ì±„íŒ…ë°© ì´ë¦„ ë³€ê²½
        async function updateRoomName() {
            const roomId = document.getElementById('roomId').value.trim();
            const newRoomName = document.getElementById('newRoomName').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId || !newRoomName) {
                alert('ì±„íŒ…ë°© IDì™€ ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/name?newName=' + encodeURIComponent(newRoomName), {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log('ì±„íŒ…ë°© ì´ë¦„ ë³€ê²½ ì„±ê³µ!', 'good');
                    log('ìƒˆë¡œìš´ ì´ë¦„: ' + newRoomName, 'good');
                    document.getElementById('newRoomName').value = '';
                } else {
                    const error = await response.text();
                    log('ì±„íŒ…ë°© ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('ì±„íŒ…ë°© ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }

        // ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ
        async function getRoomInfo() {
            const roomId = document.getElementById('roomId').value.trim();
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!roomId) {
                alert('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/rooms/' + roomId + '/messages?size=1', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const roomInfo = result.data;
                    
                    const roomInfoDiv = document.getElementById('roomInfo');
                    roomInfoDiv.style.display = 'block';
                    roomInfoDiv.innerHTML = `
                        <h4>ì±„íŒ…ë°© ì •ë³´</h4>
                        <p><strong>ID:</strong> ${roomInfo.content[0]?.chatRoomId || roomId}</p>
                        <p><strong>ì°¸ì—¬ì ìˆ˜:</strong> ${roomInfo.totalElements}ëª…</p>
                        <p><strong>ë§ˆì§€ë§‰ ë©”ì‹œì§€:</strong> ${roomInfo.content[0]?.content || 'ì—†ìŒ'}</p>
                    `;
                    
                    log('ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì„±ê³µ!', 'good');
                } else {
                    const error = await response.text();
                    log('ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + error, 'bad');
                }
            } catch (error) {
                log('ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'bad');
            }
        }
        
        // í…ŒìŠ¤íŠ¸ìš© UUID ìƒì„± í•¨ìˆ˜
        function generateTestRoomId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>