<!doctype html>
<meta charset="utf-8" />
<title>STOMP 1:1 Realtime Test</title>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
body{font:14px system-ui;margin:20px;max-width:720px}
#log{border:1px solid #ccc;border-radius:8px;padding:8px;height:240px;overflow:auto;white-space:pre-wrap}
.row{display:flex;gap:8px;margin:6px 0}
input,button{padding:8px;border:1px solid #bbb;border-radius:8px}
input{flex:1}
.bad{color:#b00020}.good{color:#0a7a0a}
.message{background:#f0f0f0;padding:4px;margin:2px 0;border-radius:4px}
.message.sent{background:#e3f2fd;text-align:right}
.message.received{background:#f1f8e9}
</style>

<h2>STOMP 1:1 Realtime Test</h2>
<div class="row"><label style="width:140px">SockJS URL</label>
  <input id="url" value="http://localhost:8080/ws/chat">
</div>
<div class="row"><label style="width:140px">My User ID</label>
  <input id="me" placeholder="USER_A_ID">
</div>
<div class="row"><label style="width:140px">Peer User ID</label>
  <input id="peer" placeholder="USER_B_ID">
</div>
<div class="row"><label style="width:140px">JWT (opt)</label>
  <input id="jwt" placeholder="USER_A_JWT (optional)">
</div>
<div class="row"><label style="width:140px">Room ID</label>
  <input id="roomId" placeholder="채팅방 ID (UUID)">
</div>
<div class="row">
  <button id="btnConn">Connect</button>
  <button id="btnClose" disabled>Close</button>
</div>
<div class="row">
  <input id="msg" placeholder="Type message…" disabled>
  <button id="btnSend" disabled>Send</button>
</div>

<p>Status: <span id="status" class="bad">disconnected</span></p>
<div id="log"></div>

<script>
let client, sub;
const $ = id => document.getElementById(id);
const log = (m, cls='') => { const d = document.createElement('div'); d.className=cls; d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`; $('log').appendChild(d); $('log').scrollTop = $('log').scrollHeight; };

// 메시지 표시 함수 추가
const displayMessage = (data, isSent = false) => {
  let messageText = '';
  let senderName = '';
  
  try {
    if (data.type === 'chat.message' && data.payload) {
      // WsEnvelope 구조 처리
      const payload = data.payload;
      messageText = payload.content || '내용 없음';
      senderName = payload.sender ? payload.sender.nickname : '알 수 없음';
    } else if (data.content) {
      // 직접 속성 처리
      messageText = data.content;
      senderName = data.sender ? data.sender.nickname : '알 수 없음';
    } else {
      messageText = JSON.stringify(data);
      senderName = '시스템';
    }
  } catch (e) {
    messageText = JSON.stringify(data);
    senderName = '시스템';
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  messageDiv.textContent = `${isSent ? '나' : senderName}: ${messageText}`;
  
  $('log').appendChild(messageDiv);
  $('log').scrollTop = $('log').scrollHeight;
};

$('btnConn').onclick = () => {
  const jwt = $('jwt').value.trim();
  const sock = new SockJS($('url').value + (jwt ? `?token=${encodeURIComponent(jwt)}` : ''));
  client = Stomp.over(sock);
  client.reconnect_delay = 0; // 재연결 비활성 (스모크용)

  client.connect({}, frame => {
    $('status').textContent = 'connected'; $('status').className = 'good';
    $('btnClose').disabled = false; $('btnSend').disabled = false; $('msg').disabled = false;
    log('connected ✅','good');

    // 개인 큐 구독 - 메시지 수신 및 화면 표시
    sub = client.subscribe('/user/queue/messages', msg => {
      log('recv: ' + msg.body);
      try {
        const data = JSON.parse(msg.body);
        displayMessage(data, false); // 수신된 메시지를 화면에 표시
      } catch (e) {
        log('메시지 파싱 오류: ' + e.message, 'bad');
      }
    });

    // 수신증명 구독
    client.subscribe('/user/queue/receipts', msg => {
      log('receipt: ' + msg.body, 'good');
    });

    // 에러 구독
    client.subscribe('/user/queue/errors', msg => {
      log('error: ' + msg.body, 'bad');
    });

    // 필요 시 HELLO 전송
    // client.send('/app/hello', {}, JSON.stringify({ me: $('me').value }));
  }, err => log('stomp error: ' + err, 'bad'));
};

$('btnClose').onclick = () => { try{ sub && sub.unsubscribe(); client && client.disconnect(()=>{});}catch(e){}; $('status').textContent='disconnected'; $('status').className='bad'; };

$('btnSend').onclick = () => {
  const roomId = $('roomId').value.trim();
  const content = $('msg').value.trim();
  
  if (!roomId || !content) {
    alert('채팅방 ID와 메시지를 입력하세요.');
    return;
  }
  
  const payload = {
    roomId: roomId,
    content: content,
    clientMessageId: 'c-' + Math.random().toString(36).slice(2)
  };
  
  log('send: ' + JSON.stringify(payload));
  
  // 수정된 경로: /app/send-message (서버의 @MessageMapping과 일치)
  client.send('/app/send-message', {}, JSON.stringify(payload));
  
  // 전송한 메시지를 화면에 즉시 표시
  displayMessage({ content: content, sender: { nickname: '나' } }, true);
  
  $('msg').value = '';
};

$('msg').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('btnSend').click(); });
</script>
